<dom-module id="modal-force-password-change">
	<template>
		<style>
			px-modal[overlay] {
			    background: rgba(0,0,0,.7);
            }
		:host /deep/ .content {
                transform: translateX(-50%) translateY(-50%);
                -webkit-transform: translateX(calc(-50% - .5px)) translateY(calc(-50% - .5px)) !important;
        }
		</style>
		<px-modal overlay class="visible">
			<px-actionbar dark>
				<px-title maintitle="[[data.title]]" flex></px-title>
			</px-actionbar>
			<px-content>
				<table style="border-collapse: collapse;" id="contents">
					<tr>
						<td style="width: 150px; padding-bottom: 20px;"><b>Username:      </b></td>
						<td style="padding-bottom: 20px;">[[userName]]</td>
					</tr>
					<tr>
						<td style="width: 150px; padding-bottom: 20px;"><b>Current Password:   </b></td>
						<td id="currentPswd" style="padding-bottom: 20px;">
							<px-input type="password" value={{currentpassword}} on-keypress="keyPressEnter" id="currentPassword" required />
						</td>
					</tr>
					<tr>
						<td style="width: 150px; padding-bottom: 20px;"><b>New Password: </b><iron-icon icon="px-icons:information" style="height: 16px;width: 16px;margin-bottom: 4px;" title="[[_getToolTip(passwordComplexity)]]"></iron-icon></td>
						<td id="newPswd" style="padding-bottom: 20px;">
							<px-input id="newPassword" on-keypress="keyPressEnter" type="password" value={{newPassword}} invalid="[[_validatePassword(newPassword,passwordComplexity,userName)]]" maxlength="20" required />
						</td>
					</tr>
					<tr>
						<td style="width: 150px; padding-bottom: 20px;"><b>Confirm Password:   </b></td>
						<td id="confirmPswd" style="padding-bottom: 20px;">
							<px-input id="newPassword2" on-keypress="keyPressEnter" type="password" value={{newPassword2}} invalid="[[_validateConfirmPassword(newPassword, newPassword2)]]" maxlength="20" required />
						</td>
					</tr>
				</table>
			</px-content>
			<px-actionbar bottom>
				<span class="flex"></span>
					<px-button on-click="cancel">Cancel</px-button>
					<px-button on-click="changePassword" primary>Ok</px-button>
				<span class="flex"></span>
			</px-actionbar>
		</px-modal>
	</template>
	<script>
	Polymer({
		is: 'modal-force-password-change',
		properties: {
			tab: {
				type: Object,
				notify: true
			},
			data: {
				type: Object,
				notify: true
			}
		},
		attached: function() {
			this.userName = PB.currentUser.UserName.value;
			this.passwordComplexity =PB.currentUser.PwdComplexity.value;
		},
		_validatePassword: function(password,passwordComplexity,userName) {
			switch(passwordComplexity) {
                    case '0': 	if(password != null) {
                                    if(/^.{6,}$/.test(password) && !(/[^\S]/.test(password)) && password != userName) {
                                        return false;
                                    }
                                    return true;
                                }	
                                break;
                    case '1':	if(password != null) {
                                    if(/^.{8,}$/.test(password) && /\d/.test(password) && /[a-zA-Z]/.test(password) && !(/[^\S]/.test(password)) && password != userName) {
                                        return false;							
                                    }
                                    return true;
                                }	
                                break;
                    case '2':	if(password != null) {
                                    if(/^.{12,}$/.test(password) && /\d/.test(password) && /[a-zA-Z]/.test(password) && /[^a-zA-Z\d\s]/.test(password) && !(/[^\S]/.test(password)) && /[A-Z]/.test(password) && password != userName) {
                                        return false;				
                                    }
                                    return true;
                                }	
                                break;
                    case '3':	if(password != null) {
                                    if(/^.{16,}$/.test(password) && /\d/.test(password) && /(?=(.*[A-Za-z]){2})/.test(password) && /(?=(.*[^a-zA-Z\d\s]){2})/.test(password) && !(/[^\S]/.test(password)) && /[A-Z]/.test(password) && /[a-z]/.test(password) && password != userName){
                                        return false;					
                                    }
                                    return true;
                                }	
                                break;
                }	
		},
        _getToolTip: function (passwordComplexity) {
			var message;
			switch(passwordComplexity) {
                    case '0': 
                                message="Password must meet the following requirements:\n" +
                                "- Be at least 6 characters\n" +
                                "- Not same as User name or Full name\n" +
                                "- Not same as existing or default password";
                                break;
                    case '1': 
                                message="Password must meet the following requirements:\n" +
                                "- Be at least 8 characters\n" +
                                "- At least 1 letter\n" +
                                "- At least 1 number\n" +
                                "- Not same as User name or Full name\n" +
                                "- Not same as existing or default password";
                                break;
                    case '2': 
                                message="Password must meet the following requirements:\n" +
                                "- Be at least 12 characters\n" +
                                "- At least 1 letter\n" +
                                "- At least 1 number\n" +
                                "- At least 1 special character\n" +
                                "- At least 1 capital letter\n" +
                                "- Not same as User name or Full name\n" +
                                "- Not same as existing or default password";
                                break;
                    case '3': 
                                message="Password must meet the following requirements:\n" +
                                "- Be at least 16 characters\n" +
                                "- At least 2 letters\n" +
                                "- At least 1 number\n" +
                                "- At least 2 special characters\n" +
                                "- At least 1 capital letter\n" +
                                "- At least 1 lowercase letter\n" +
                                "- Not same as User name or Full name\n" +
                                "- Not same as existing or default password";
                                break;
                }
		  return message;
		},
		_validateConfirmPassword: function(pass, confirmPass) {
			if (confirmPass != null) {
				if (pass == confirmPass && confirmPass != '') {
					return false;
				}
				return true;
			}
		},
		keyPressEnter: function (event) {
				if (this.newPassword != '' && this.newPassword != null && this.newPassword2 != '' && this.newPassword2  != null && this.currentpassword != '' && this.currentpassword  != null) {
					if (event.keyCode === 13 || event.key === 'Enter' || event.code === 'Enter') {
						this.changePassword();
					}
				}
			},
		cancel:function(){
			PB.appLogout();
		},
		changePassword: function() {
			var self= this;
			if (!self.newPassword2 || !self.newPassword) {
				navbar.showConfirm("Please provide required inputs.", "Alert", ["Ok"])
					.then(function (result) {
						switch (result) {
							case 0: // Cancel - do nothing
								break;
						}
					});
				return;
			}
			if (self.newPassword != self.newPassword2) {
				navbar.showConfirm("Passwords do not match.", "Alert", ["Ok"])
					.then(function (result) {
						switch (result) {
							case 0: // Cancel - do nothing
								break;
						}
					});
				return;
			}
			var loggedInUserPwd = (function () {
				var password = window.btoa(self.currentpassword);
				return '<LoggedInUserPwd>' + password + '</LoggedInUserPwd>'
			})();
			var newPassword = (function () {
				var password = window.btoa(self.newPassword);
				return '<Pwd>' + password + '</Pwd>'
			})();
			var theDate = (function () {
				var currentEpoch = Math.floor(new Date().getTime() / 1000.0);
				return '<PwdSetEpochTime>' + currentEpoch + '</PwdSetEpochTime>';
			})();
			var userID = PB.currentUser.url
			var setData = '<UserAccount>' + loggedInUserPwd + newPassword + theDate + '</UserAccount>';
			PB.http('PUT', userID, setData).then(function (xhr) {
				window.location.href = "/";
			}, function (xhr) {
				var message = xhr.statusText;
				if (xhr.status && xhr.status > 0) {
					if (xhr.status === 400) {
						message = "Invalid inputs";
					} else if (xhr.status === 403) {
						message = "Invalid logged in user password";
					}
					navbar.showConfirm(message, "Alert", ["Ok"])
						.then(function (result) {
							switch (result) {
								case 0: // Cancel - do nothing
									break;
							}
						});
				}
				return;
			});
		},
	});
	</script>
</dom-module>