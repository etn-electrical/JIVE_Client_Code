# IoT initialization and connection to Azure IoT hub

## Initial sequence

> When the device is powered ON, it goes through the different stages before it establishes connection to IoT hub:

* Initialize hardware peripherals and RTOS
* Network initialization
* Once ethernet or network link is up, set IP address allocation method to DHCP/static IP and then IP address gets allocated
* Initialize IoT and open a secure TLS connection to Azure IoT hub
* Once the connection is authenticated, its status is "IoT connected"
* Device tree message is the first Device-to-cloud message that is published. It contains device information like device GUID, device profile ID, name and MAC address
* All realtimes and trends data are published at once on connect by default
* Interval-based StoreMe data is published after every N (eg, 60) seconds whereas other groups' data is published only after there is a change in channel value
* There is a mechanism that keeps track of IoT connection status every 10s. If IoT gets disconnected then it will close the connection and retry to open a new connection

## IoT initialization steps

* Initialize and configure a timer for 10 seconds interval. It is used to keep track of IoT connection status and reconnection
* Get IoT configuration parameters
* If IoT is configured as enabled i.e when DCID DCI_IOT_CONNECT is "true" then IoT connection status reason is set to "IOT_INITIALIZING"
* TLS connection is initialized by loading keys using Azure trusted CA Baltimore certificate
* Initialize cadence groups as per the configuration and identify the realtimes/SeeMe, trends/StoreMe and trends/StoreMe on interval types of channels
* For realtimes/SeeMe and StoreMe(aka StoreMe on change) types of channels, attach change tracker mechanism to detect the change in channel values
* Initialize and configure a timer for each cadence group.

## IoT connection steps

* Once IoT is initialized, it is important that device clock is in synchronization with the current time
If device's clock is correctly set then a secured IoT connection is opened by TLS handshaking procedure. The communication protocol used here is MQTT websockets. Device's connection string is used for authentication purpose.

* The following 3 callbacks are registered after IoT connection is opened

  * Connection status update callback which is invoked when of IoT connection status changes. It also lists the reasons for connection failures

  * Receive cloud-to-device message callback that handles incoming commands from cloud and gives response
  
  * Timer callback which invokes within 1 second. It has a state machine implementation for publishing device tree message and channels messages

* Once the connection is established, the data exchange takes place using TLS encrypted messages.
* Additional security is provided by SAS token that requires a refresh after 80% of the interval defined by "IOT_SAS_TOKEN_REFRESH_SECS"

## IoT re-connection scenarios

> Sometimes it might happen that IoT gets disconnected and we need to retry to open IoT connection until it is successful. One of the following reasons might be responsible for IoT disconnection.

* **IOT_INITIALIZING**  
This is the default state when IoT is getting initialized
* **IOT_CLOUD_CONNECTED**  
This status is shown when device gets connected to IoT hub successfully
* **IOT_DISABLED**  
This status is shown when user configures to disable IoT
* **IOT_CLOCK_INCORRECT**  
This status is shown when device's clock is not in synchronization with current time. Before opening an IoT connection, device fetches current time, eg from an SNTP server. If it fails to get the time, eg from an SNTP server, then the IoT connection will fail to open.
* **IOT_RECONNECTING**  
This status is shown when device closes an existing connection and open a new one. There are two reasons when device needs to reconnect.
  * When IoT configuration is changed in run time by the user
  * When IoT is opening the connection
* **IOT_FAILED_TO_OPEN_CONN**  
This status is shown when IoT connection fails to open. This might occur, eg,  when we try to re-open the connection before closing the existing connection.
* **IOT_INVALID_CONN_STRING**  
This status is shown when connection string is determined to be invalid.
* **IOT_INVALID_CONFIG**  
This status is shown when device GUID  is not the same as the one which is present in connection string
* **IOT_EXPIRED_SAS_TOKEN**  
This status is shown when SAS token has expired and must be refreshed. MQTT websockets uses SAS token that requires a refresh(New SAS token is generated by Azure SDK) after an interval of 80% of the "IOT_SAS_TOKEN_REFRESH_SECS". When SAS token expires, the status IOT_EXPIRED_SAS_TOKEN will be shown until we reconnect.
* **IOT_DEVICE_DISABLED**  
This status is shown when the device is disabled by user by setting cloudenable state to "false", eg using swagger UI
* **IOT_RETRY_EXPIRED**  
The Azure IoT Hub Client has a feature called RetryPolicy (which can be set using IotHubClient_SetRetryPolicy). It has a property that limits the maximum time the client can attempt to reconnect when failures occur. If that maximum time is reached, the Connection Status is invoked with status UNAUTHENTICATED and reason RETRY_EXPIRED.
* **IOT_NO_NETWORK**  
If retry policy is disabled, this error reason might be provided to indicate there is a network connection issue. This status is also shown when device is not able to reach the proxy server. (You can disable proxy and check if IoT gets connected)
* **IOT_COMMUNICATION_ERROR**  
If retry policy is disabled, this error reason might be provided to indicate there is a network connection issue
* **IOT_TLS_INIT_FAILED**  
This status is shown when TLS initialization fails due to failure in loading SSL certificate key
* **IOT_NETWORK_LINK_DOWN**  
This status is shown when link is down. This happens when ethernet cable or network interface is disconnected
* **IOT_UNKNOWN_ERROR**  
This status is shown when error reason is other than the above error reasons
* **IOT_DAILY_LIMIT_REACHED**  
Each IoT hub is provisioned with a certain number of units. The number of units determine the maximum daily quota of messages that you can send which is 4KB. If the daily messages exceed 4KB then IoT hub starts rejecting the subsequent requests and status IOT_DAILY_LIMIT_REACHED will be shown
* **IOT_TOO_MANY_LOST_MESSAGES**  
If the daily messages exceed 4KB then IoT hub starts rejecting the subsequent requests until the next day starts. During this time when too many messages are lost, the status IOT_TOO_MANY_LOST_MESSAGES will be shown
